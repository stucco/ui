<meta charset="US-ASCII">
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="stylesheet" type="text/css" href="rexster-query-component.css">

<polymer-element name="rexster-query-component" attributes="queryHost queryPort vertexType vertexTypeOptions results">

    <template>
      <style type="text/css">
        paper-input-decorator /deep/ .focused-underline {
          background-color: #4285f4;
        }
        paper-button[raised].blue {
          background-color: #4285f4;
          color: #fff;
        }
        paper-radio-button.blue::shadow #ink[checked] {
          color: #4285f4;
        }
        paper-radio-button.blue::shadow #onRadio {
          background-color: #4285f4;
        }
      </style>
      <section>
        <core-ajax id="rexreq" url="http://{{queryHost}}:{{queryPort}}/graphs/graph/tp/gremlin" handleAs="json" contentType="application/json" headers='{"Accept": "application/json"}' on-core-response="{{queryRexster}}" on-core-error="{{handleError}}" on-core-complete="{{handleCompletion}}"></core-ajax>

        <div horizontal layout>
          <div flex>
            <paper-input-decorator label="Query string">
              <input id="query-input" value="{{userInput}}"  />
            </paper-input-decorator>
          </div>
          <div>
            <paper-button id="queryButton" raised class="blue" on-click="{{submitQuery}}">Submit Query</paper-button>
            <paper-spinner id="spinner"></paper-spinner>
          </div>
        </div>
      </section>

      <section>
        <h5>Filter Query By Vertex Type:</h5>
        <div horizontal layout>
          <paper-radio-group id="vTypeSelector" selected="Gremlin">
            <template repeat="{{vType in vertexTypeOptions}}">
              <paper-radio-button class="blue" name="{{vType}}" label="{{vType}}"></paper-radio-button>
            </template>
            <br /><paper-radio-button class="blue" name="Gremlin" label="Gremlin"></paper-radio-button>
          </paper-radio-group>
        </div>
      </section>

      <paper-toast id="resultsMsg" text="Query returned 0 results."></paper-toast>
      <paper-toast id="invalidMsg" text="Query is invalid."></paper-toast>
      <paper-toast id="errorMsg" text="Server error."></paper-toast>
    </template>

    <script>
        Polymer('rexster-query-component', {
           queryHost : "localhost",
           queryPort : 8182,
       userInput : "",
       results : [],
       vertexType : "Gremlin",
       vertexTypeOptionsChanged : function() {
          if ((this.vertexTypeOptions) && (this.vertexTypeOptions.length > 0)) {
            this.$.vTypeSelector.selected = this.vertexTypeOptions[0];
          }
        },
        submitQuery : function() {
            this.$.spinner.active = true;
            this.$.queryButton.hidden = true;
            this.userInput = this.userInput.trim();
            this.vertexType = this.$.vTypeSelector.selected;
            if (this.validateQuery()) {
                this.getRexsterQuery();
                this.$.rexreq.go();
            }
            this.$.spinner.active = false;
            this.$.queryButton.hidden = false;
       },
       validateQuery : function() {
         var queryPattern = /.+[><=\.]+.+/;
         if ((this.userInput.length > 0) && (queryPattern.test(this.userInput))) {
           return true;
         }
         else {
            this.$.invalidMsg.show();
         }
         return false;
       },
       getRexsterQuery : function() {
           var paramString = "{\"script\":\"g.V.has(";
         if (this.vertexType != "Gremlin") {
            paramString = paramString.concat("'vertexType','" + this.vertexType + "')");
            var filterPairs = this.userInput.split(",");
            for (var i=0; i<filterPairs.length; i++) {
              var keyValue = filterPairs[i].split(">=");
              if (keyValue.length == 2) {
                paramString = paramString.concat(".has('");
                paramString = paramString.concat(keyValue[0].trim() + "',T.gte,'" + keyValue[1].trim() + "')");
                continue;
              }
              keyValue = filterPairs[i].split("<=");
              if (keyValue.length == 2) {
                paramString = paramString.concat(".has('");
                paramString = paramString.concat(keyValue[0].trim() + "',T.lte,'" + keyValue[1].trim() + "')");
                continue;
              }
              keyValue = filterPairs[i].split("!=");
              if (keyValue.length == 2) {
                if ((keyValue[1].charAt(0) == '"') || (keyValue[1].charAt(0) == "'")) {
                  keyValue[1] = keyValue[1].substr(1);
                }
                if ((keyValue[1].charAt(keyValue[1].length-1) == '"') || (keyValue[1].charAt(keyValue[1].length-1) == "'")) {
                  keyValue[1] = keyValue[1].substring(0,keyValue[1].length-1);
                }
                paramString = paramString.concat(".has('");
                paramString = paramString.concat(keyValue[0].trim() + "',T.neq,'" + keyValue[1].trim() + "')");
                continue;
              }
              keyValue = filterPairs[i].split("=");
              if (keyValue.length == 2) {
                if ((keyValue[1].charAt(0) == '"') || (keyValue[1].charAt(0) == "'")) {
                  keyValue[1] = keyValue[1].substr(1);
                }
                if ((keyValue[1].charAt(keyValue[1].length-1) == '"') || (keyValue[1].charAt(keyValue[1].length-1) == "'")) {
                  keyValue[1] = keyValue[1].substring(0,keyValue[1].length-1);
                }
                paramString = paramString.concat(".has('");
                paramString = paramString.concat(keyValue[0].trim() + "','" + keyValue[1].trim() + "')");
                continue;
              }
              keyValue = filterPairs[i].split(">");
              if (keyValue.length == 2) {
                paramString = paramString.concat(".has('");
                paramString = paramString.concat(keyValue[0].trim() + "',T.gt,'" + keyValue[1].trim() + "')");
                continue;
              }
              keyValue = filterPairs[i].split("<");
              if (keyValue.length == 2) {
                paramString = paramString.concat(".has('");
                paramString = paramString.concat(keyValue[0].trim() + "',T.lt,'" + keyValue[1].trim() + "')");
                continue;
              }
            }
         }
         else {
            paramString = "{\"script\":\"" + this.userInput.trim();
         }
         paramString = paramString.concat("\", \"rexster.offset.start\":0, \"rexster.offset.end\":30}");
         this.$.rexreq.params = paramString;
       },
       queryRexster : function() {
         if (this.$.rexreq.response.results) {
            if (this.$.rexreq.response.results.length > 0) {
              this.results = this.$.rexreq.response.results;
            }
            else {
              this.$.resultsMsg.show();
            }
          }
          else {
          	this.$.resultsMsg.show();
          }
       },
       handleError : function() {
            this.$.errorMsg.show();
       },
       handleCompletion : function() {
            this.$.spinner.active = false;
            this.$.queryButton.hidden = false;
       }
        });
    </script>
</polymer-element>
