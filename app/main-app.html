<meta charset="US-ASCII">
<link rel="import" href="bower_components/polymer/polymer.html">
<script src="bower_components/jquery/dist/jquery.js"></script>

<link rel="import" href="elements/elements.html">

<polymer-element name="main-app" attributes="querySource resultsView historyView queryHost queryPort">

  <template>
    <query-component id="queryCom" results="{{results}}" querySource="{{querySource}}" queryHost="{{queryHost}}" queryPort="{{queryPort}}" vertexType="{{vertexType}}" vertexTypeOptions="{{vertexTypeOptions}}" hidden?="{{!showQuery}}"></query-component>

    <results-component id="resultsCom" rowData="{{results}}" detailId="{{detailId}}" resultsView="{{resultsView}}" hidden?="{{!showResults}}"></results-component>

    <detail-query-component id="detailQueryCom" queryHost="{{queryHost}}" queryPort="{{queryPort}}" queryParams="{{detailId}}" vertex="{{vertex}}" edges="{{edges}}" edgeTable="{{edgeTable}}" edgeTypeMap="{{edgeTypeMap}}"></detail-query-component>

    <traversal-component id="traverseCom" vertexDetails="{{vertex}}" edgeDetails="{{edges}}" historyView="{{historyView}}" nextVertexId="{{nextVertexId}}" vProps="{{vProps}}" hidden?="{{!showTraversal}}"></traversal-component>

    <p>
        <button on-click="{{goToQuery}}" hidden?="{{showQuery}}">Go To Query</button>
    </p>
  </template>

  <script>
    var vertexOntology = [];
    var edgeOntology = [];
    var vTypes = [];
 	var edgeMap = {};
    Polymer("main-app", {
      querySource : "",
      resultsView : "",
      historyView : "",
      showQuery : true,
      showResults : false,
      showTraversal : false,
      vProps : [],
      vertexTypeOptions : [],
      edgeTypeMap : {},
      ready : function() {
          this.querySource = this.querySource || "rexster";
          this.resultsView = this.resultsView || "table";
          this.historyView = this.historyView || "grid";
          jQuery.getJSON('ontology/stucco_schema.json', function(json) {
              vertexOntology = json["properties"]["vertices"]["items"];
              edgeOntology = json["properties"]["edges"]["items"];
          }).done( function() {
              for (var i=0; i<vertexOntology.length; i++) {
                  vTypes.push(vertexOntology[i]["title"]);
              }
              for (i=0; i<edgeOntology.length; i++) {
              	if (edgeOntology[i]["properties"]["outVType"]["enum"]) {
                  var key = edgeOntology[i]["properties"]["outVType"]["enum"][0].concat("_").concat(edgeOntology[i]["properties"]["inVType"]["enum"][0]);
                  var edgeLabel = edgeOntology[i]["title"];
                  edgeMap[key] = edgeLabel;
              	}
              }    
          });
          this.vertexTypeOptions = vTypes;
          this.edgeTypeMap = edgeMap;
      },
      resultsChanged : function() {
          if (this.$.queryCom.results.length > 0) {
              this.showQuery = !this.showQuery;
              this.showResults = !this.showResults;
          }
      },
      vertexChanged : function() {
          if (this.$.detailQueryCom.vertex["vertexType"]) {
              for (var i=0; i<vertexOntology.length; i++) {
                  var currentVert = vertexOntology[i];
                  if (currentVert["title"] == this.$.detailQueryCom.vertex["vertexType"]) {
                      this.vProps = Object.keys(currentVert["properties"]);
                      break;
                  }
              }
          }
      },
      nextVertexIdChanged : function() {
        var nextId = this.$.traverseCom.nextVertexId;
        this.$.detailQueryCom.queryParams = nextId;
          if (nextId != "") {
              this.showResults = false;
              this.showTraversal = true;
          }
      },
      detailIdChanged : function() {
          if ((this.$.detailQueryCom.queryParams != "") && (this.$.traverseCom.nextVertexId == "")) {
              this.showResults = !this.showResults;
              this.showTraversal = !this.showTraversal;
          }
      },
      goToQuery : function() {
          window.location.assign(window.location.origin);
      }
    });
  </script>
</polymer-element>