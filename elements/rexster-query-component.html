<meta charset="US-ASCII">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<polymer-element name="rexster-query-component" attributes="queryHost queryPort vertexType vertexTypeOptions results">
    <template>
    	<style type="text/css">
	        #vTypeSelector {
	        	width: 50%;
	        }
        </style>
    	<core-ajax id="rexreq" url="http://{{queryHost}}:{{queryPort}}/graphs/graph/tp/gremlin" handleAs="json" contentType="application/json" headers='{"Accept": "application/json"}' on-core-response="{{queryRexster}}"></core-ajax>
		<input id="query" type="text" size="100" value="{{userInput}}" /> 
		
		<button type="button" on-click="{{submitQuery}}">Submit Query</button>
		<p>
		<b>Filter Query By Vertex Type:</b>
		</p>
		<paper-radio-group id="vTypeSelector" selected="script">
			<template repeat="{{vType in vertexTypeOptions}}">
				<paper-radio-button name="{{vType}}" label="{{vType}}"></paper-radio-button>
			</template>
			<br /><paper-radio-button name="script" label="script"></paper-radio-button>
		</paper-radio-group>
    </template>
    <script>
        Polymer('rexster-query-component', {
           queryHost : "localhost",
           queryPort : 8182,
		   userInput : "",
		   results : [],
		   vertexType : "script",
		   vertexTypeOptionsChanged : function() {
		   		console.log("types " + this.vertexTypeOptions[0]);
		   		if ((this.vertexTypeOptions) && (this.vertexTypeOptions.length > 0)) {
		   			this.$.vTypeSelector.selected = this.vertexTypeOptions[0];
		   		}
		   },
           submitQuery : function() {
			   this.userInput = this.userInput.trim();
			   this.vertexType = this.$.vTypeSelector.selected;
               if (this.validateQuery()) {
				 	this.getRexsterQuery();
				 	this.$.rexreq.go();
               }
			   else {
				 	this.userInput = "";
			   }
           },
		   validateQuery : function() {
			   var queryPattern = /.*[><=]?.*/;
			   if ((this.userInput.length > 0) & (queryPattern.test(this.userInput))) {
				   return true;
			   }
			   else {
			   		console.log(this.userInput + " is not valid!");
			   }
			   return false;
		   },
		   getRexsterQuery : function() {
		   	   var paramString = "{\"script\":\"g.V.has(";
			   if (this.vertexType != "script") {
			   		paramString = paramString.concat("'vertexType','" + this.vertexType + "')");
			   		var filterPairs = this.userInput.split(",");
			   		for (var i=0; i<filterPairs.length; i++) {
			   			var keyValue = filterPairs[i].split(">=");
			   			if (keyValue.length == 2) {
			   				paramString = paramString.concat(".has('");
			   				paramString = paramString.concat(keyValue[0].trim() + "',T.gte,'" + keyValue[1].trim() + "')");
			   				continue;
			   			}
			   			keyValue = filterPairs[i].split("<=");
			   			if (keyValue.length == 2) {
			   				paramString = paramString.concat(".has('");
			   				paramString = paramString.concat(keyValue[0].trim() + "',T.lte,'" + keyValue[1].trim() + "')");
			   				continue;
			   			}
			   			keyValue = filterPairs[i].split("!=");
			   			if (keyValue.length == 2) {
			   				if ((keyValue[1].charAt(0) == '"') || (keyValue[1].charAt(0) == "'")) {
			   					keyValue[1] = keyValue[1].substr(1);
			   				}
			   				if ((keyValue[1].charAt(keyValue[1].length-1) == '"') || (keyValue[1].charAt(keyValue[1].length-1) == "'")) {
			   					keyValue[1] = keyValue[1].substring(0,keyValue[1].length-1);
			   				}
			   				paramString = paramString.concat(".has('");
			   				paramString = paramString.concat(keyValue[0].trim() + "',T.neq,'" + keyValue[1].trim() + "')");
			   				continue;
			   			}
			   			keyValue = filterPairs[i].split("=");
			   			if (keyValue.length == 2) {
			   				if ((keyValue[1].charAt(0) == '"') || (keyValue[1].charAt(0) == "'")) {
			   					keyValue[1] = keyValue[1].substr(1);
			   				}
			   				if ((keyValue[1].charAt(keyValue[1].length-1) == '"') || (keyValue[1].charAt(keyValue[1].length-1) == "'")) {
			   					keyValue[1] = keyValue[1].substring(0,keyValue[1].length-1);
			   				}
			   				paramString = paramString.concat(".has('");
			   				paramString = paramString.concat(keyValue[0].trim() + "','" + keyValue[1].trim() + "')");
			   				continue;
			   			}
			   			keyValue = filterPairs[i].split(">");
			   			if (keyValue.length == 2) {
			   				paramString = paramString.concat(".has('");
			   				paramString = paramString.concat(keyValue[0].trim() + "',T.gt,'" + keyValue[1].trim() + "')");
			   				continue;
			   			}
			   			keyValue = filterPairs[i].split("<");
			   			if (keyValue.length == 2) {
			   				paramString = paramString.concat(".has('");
			   				paramString = paramString.concat(keyValue[0].trim() + "',T.lt,'" + keyValue[1].trim() + "')");
			   				continue;
			   			}
			   		}
			   }
			   else {
			   		paramString = "{\"script\":\"" + this.userInput.trim();
			   }
			   paramString = paramString.concat("\", \"rexster.offset.start\":0, \"rexster.offset.end\":10}");
			   console.log("rexster-query-component parameters = " + paramString);
			   this.$.rexreq.params = paramString;
		   },
		   queryRexster : function() {
		   		if (this.$.rexreq.response.results.length > 0) {
		   			this.vertexType = this.$.rexreq.response.results[0]["vertexType"];
		   			this.results = this.$.rexreq.response.results;
		   		}
		   }
        });
    </script>
</polymer-element>
