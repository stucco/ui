<meta charset="US-ASCII">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<polymer-element name="rexster-query-component" attributes="queryHost queryPort vertexType results">
    <template>
    	<core-ajax id="rexreq" url="http://{{queryHost}}:{{queryPort}}/graphs/graph/tp/gremlin" handleAs="json" contentType="application/json" headers='{"Accept": "application/json"}' on-core-response="{{queryRexster}}"></core-ajax>
		<input id="query" type="text" size="100" value="{{userInput}}" /> 
		
		<button type="button" on-click="{{submitQuery}}">Submit Query</button>
    </template>
    <script>
        Polymer('rexster-query-component', {
           queryHost : "localhost",
           queryPort : 8182,
		   userInput : "MA",//"script:g.V.has('discoveryDate',GREATER_THAN,'2009-11-08').has('discoveryDate',LESS_THAN,'2009-11-10')",
		   results : [],
		   vertexType : "software",
           ready : function() {
           },
           submitQuery : function() {
			   this.userInput = this.userInput.trim();
               if (this.validateQuery()) {
				 	this.getRexsterQuery();
				 	this.$.rexreq.go();
               }
			   else {
				 	this.userInput = '';
			   }
           },
		   validateQuery : function() {
			   var queryPattern = /[A-Z]+:?.*=?.*/;
			   if ((this.userInput.length > 0) & (queryPattern.test(this.userInput))) {
				   return true;
			   }
			   else {
			   		console.log(this.userInput + " is not valid!");
			   }
			   return false;
		   },
		   getRexsterQuery : function() {
		   	   var paramString = "{\"script\":\"g.V.has(";
			   var vertexTypeParam = "'vertexType',";
			   var inputPieces = this.userInput.split(":");
			   if (inputPieces.length >= 1) {
			   		switch (inputPieces[0]) {
			   			case 'SO' : 
			   				this.vertexType = "software";
			   				paramString = paramString.concat(vertexTypeParam + "'" + this.vertexType + "')");
			   				break;
			   			case 'MA' : 
			   				this.vertexType = "malware";
			   				paramString = paramString.concat(vertexTypeParam + "'" + this.vertexType + "')");
			   				break;
			   			case 'US' : 
			   				this.vertexType = "user";
			   				paramString = paramString.concat(vertexTypeParam + "'" + this.vertexType + "')");
			   				break;
			   			case 'AC' : 
			   				this.vertexType = "account";
			   				paramString = paramString.concat(vertexTypeParam + "'" + this.vertexType + "')");
			   				break;
			   			case 'HO' : 
			   				this.vertexType = "host";
			   				paramString = paramString.concat(vertexTypeParam + "'" + this.vertexType + "')");
			   				break;
			   			case 'VU' : 
			   				this.vertexType = "vulnerability";
			   				paramString = paramString.concat(vertexTypeParam + "'" + this.vertexType + "')");
			   				break;
			   			case 'AD' :
			   				this.vertexType = "address";
			   				paramString = paramString.concat(vertexTypeParam + "'" + this.vertexType + "')");
			   				break;
			   			case 'DN' : 
			   				this.vertexType = "DNSName";
			   				paramString = paramString.concat(vertexTypeParam + "'" + this.vertexType + "')");
			   				break;
			   			case 'IP' : 
			   				this.vertexType = "IP";
			   				paramString = paramString.concat(vertexTypeParam + "'" + this.vertexType + "')");
			   				break;
			   			case 'PO' : 
			   				this.vertexType = "port";
			   				paramString = paramString.concat(vertexTypeParam + "'" + this.vertexType + "')");
			   				break;
			   			case 'AR' : 
			   				this.vertexType = "addressRange";
			   				paramString = paramString.concat(vertexTypeParam + "'" + this.vertexType + "')");
			   				break;
			   			case 'SE' : 
			   				this.vertexType = "service";
			   				paramString = paramString.concat(vertexTypeParam + "'" + this.vertexType + "')");
			   				break;
			   			case 'FL' : 
			   				this.vertexType = "flow";
			   				paramString = paramString.concat(vertexTypeParam + "'" + this.vertexType + "')");
			   				break;
			   			case 'AT' :
			   				this.vertexType = "attack";
			   				paramString = paramString.concat(vertexTypeParam + "'" + this.vertexType + "')");
			   				break;
			   			case 'AK' : 
			   				this.vertexType = "attacker";
			   				paramString = paramString.concat(vertexTypeParam + "'" + this.vertexType + "')");
			   				break;
			   			case 'AA' : 
			   				this.vertexType = "attackAsset";
			   				paramString = paramString.concat(vertexTypeParam + "'" + this.vertexType + "')");
			   				break;
			   			case 'script' :
			   				paramString = "{\"script\":\"";
			   				for (var i=1; i<inputPieces.length; i++) {
			   					paramString = paramString.concat(inputPieces[i]);
			   				}
			   				break;
			   			default : 
			   				paramString = "{\"script\":\"g.V";
			   				break;
			   		}
			   		
			   }
			   if (inputPieces.length >= 2) {
			   		
			   		var filterPairs = inputPieces[1].split(",");
			   		for (var i=0; i<filterPairs.length; i++) {
			   			var keyValue = filterPairs[i].split(">=");
			   			if (keyValue.length == 2) {
			   				paramString = paramString.concat(".has('");
			   				paramString = paramString.concat(keyValue[0] + "',T.gte,'" + keyValue[1] + "')");
			   			}
			   			keyValue = filterPairs[i].split("<=");
			   			if (keyValue.length == 2) {
			   				paramString = paramString.concat(".has('");
			   				paramString = paramString.concat(keyValue[0] + "',T.lte,'" + keyValue[1] + "')");
			   			}
			   			keyValue = filterPairs[i].split("=");
			   			if (keyValue.length == 2) {
			   				paramString = paramString.concat(".has('");
			   				paramString = paramString.concat(keyValue[0] + "','" + keyValue[1] + "')");
			   			}
			   			keyValue = filterPairs[i].split(">");
			   			if (keyValue.length == 2) {
			   				paramString = paramString.concat(".has('");
			   				paramString = paramString.concat(keyValue[0] + "',T.gt,'" + keyValue[1] + "')");
			   			}
			   			keyValue = filterPairs[i].split("<");
			   			if (keyValue.length == 2) {
			   				paramString = paramString.concat(".has('");
			   				paramString = paramString.concat(keyValue[0] + "',T.lt,'" + keyValue[1] + "')");
			   			}

			   		}

			   }
			   paramString = paramString.concat("\", \"rexster.offset.start\":0, \"rexster.offset.end\":30}");
			   console.log("rexster-query-component parameters = " + paramString);
			   this.$.rexreq.params = paramString;
		   },
		   queryRexster : function() {
				this.results = this.$.rexreq.response.results;
		   }
        });
    </script>
</polymer-element>
